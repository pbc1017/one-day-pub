name: Deploy to Server

on:
  workflow_run:
    workflows: ['Docker Build & Push']
    types: [completed]
    branches: [main, dev] # dev ë¸Œëžœì¹˜ ì¶”ê°€
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'
      environment:
        description: 'Target environment'
        required: false
        type: choice
        options:
          - production
          - development
        default: 'production'

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      environment: ${{ steps.vars.outputs.environment }}
      domain: ${{ steps.vars.outputs.domain }}
      image_tag: ${{ steps.vars.outputs.image_tag }}
      deploy_path: ${{ steps.vars.outputs.deploy_path }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set deployment variables
        id: vars
        run: |
          # ë¸Œëžœì¹˜ ë° í™˜ê²½ ì„¤ì •
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.environment }}" == "development" ]]; then
              DEPLOY_PATH="kamf-dev"
              DOMAIN="dev.kamf.site"
              API_PORT="8001"
              WEB_PORT="3001" 
              DB_NAME="kamf_dev"
              IMAGE_TAG="${{ inputs.image_tag }}"
              ENVIRONMENT="development"
            else
              DEPLOY_PATH="kamf"
              DOMAIN="kamf.site"
              API_PORT="8000"
              WEB_PORT="3000"
              DB_NAME="kamf_prod"
              IMAGE_TAG="${{ inputs.image_tag }}"
              ENVIRONMENT="production"
            fi
          else
            # workflow_run ì´ë²¤íŠ¸ì—ì„œ ë¸Œëžœì¹˜ ê°ì§€
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            if [[ "${BRANCH}" == "dev" ]]; then
              DEPLOY_PATH="kamf-dev"
              DOMAIN="dev.kamf.site"
              API_PORT="8001"
              WEB_PORT="3001"
              DB_NAME="kamf_dev" 
              IMAGE_TAG="dev"
              ENVIRONMENT="development"
            else
              DEPLOY_PATH="kamf"
              DOMAIN="kamf.site"
              API_PORT="8000"
              WEB_PORT="3000"
              DB_NAME="kamf_prod"
              IMAGE_TAG="latest"
              ENVIRONMENT="production"
            fi
          fi

          echo "deploy_path=${DEPLOY_PATH}" >> $GITHUB_OUTPUT
          echo "domain=${DOMAIN}" >> $GITHUB_OUTPUT
          echo "api_port=${API_PORT}" >> $GITHUB_OUTPUT
          echo "web_port=${WEB_PORT}" >> $GITHUB_OUTPUT
          echo "db_name=${DB_NAME}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "deployment_time=$(date '+%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create deployment environment file
        run: |
          cat > .env.deploy << EOF
          # Deployment Configuration
          DOCKER_REGISTRY=${{ secrets.DOCKERHUB_USERNAME }}
          IMAGE_TAG=${{ steps.vars.outputs.image_tag }}
          DEPLOY_PATH=${{ steps.vars.outputs.deploy_path }}

          # Environment-specific Configuration
          NODE_ENV=production
          API_PORT=${{ steps.vars.outputs.api_port }}
          WEB_PORT=${{ steps.vars.outputs.web_port }}
          CORS_ORIGIN=http://${{ steps.vars.outputs.domain }}
          NEXT_PUBLIC_API_URL=http://${{ steps.vars.outputs.domain }}/api
          NEXT_PUBLIC_APP_URL=http://${{ steps.vars.outputs.domain }}

          # Database Configuration (ê³µìœ  MySQL)
          DB_HOST=kamf-mysql
          DB_PORT=3306
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ steps.vars.outputs.db_name }}
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}

          # JWT & Authentication
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=1h
          REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}
          REFRESH_TOKEN_EXPIRES_IN=7d
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}

          # Twilio SMS Configuration
          TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_SERVICE_SID=${{ secrets.TWILIO_SERVICE_SID }}

          # Deployment Metadata
          DEPLOYMENT_TIME=${{ steps.vars.outputs.deployment_time }}
          DEPLOYED_BY=${{ github.actor }}
          COMMIT_SHA=${{ github.sha }}
          ENVIRONMENT=${{ steps.vars.outputs.environment }}
          DOMAIN=${{ steps.vars.outputs.domain }}
          EOF

      - name: Copy deployment files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: 'deploy/,.env.deploy'
          target: '/home/${{ secrets.SERVER_USERNAME }}/${{ steps.vars.outputs.deploy_path }}/'
          strip_components: 0
          overwrite: true

      - name: Deploy to ${{ steps.vars.outputs.environment }} server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e

            echo "ðŸš€ Starting deployment to ${{ steps.vars.outputs.environment }} server..."
            echo "ðŸ“¦ Image Tag: ${{ steps.vars.outputs.image_tag }}"
            echo "ðŸŒ Environment: ${{ steps.vars.outputs.environment }}"
            echo "ðŸŒ Domain: ${{ steps.vars.outputs.domain }}"
            echo "ðŸ“‚ Deploy Path: ${{ steps.vars.outputs.deploy_path }}"
            echo "ðŸ‘¤ Deployed by: ${{ github.actor }}"
            echo "ðŸ”– Commit: ${{ github.sha }}"

            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/${{ secrets.SERVER_USERNAME }}/${{ steps.vars.outputs.deploy_path }}

            # í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
            if [ ! -f .env.deploy ]; then
              echo "âŒ .env.deploy file not found!"
              exit 1
            fi

            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chmod +x deploy/scripts/deploy.sh

            # ë°°í¬ ì‹¤í–‰
            echo "ðŸ“¥ Executing deployment script..."
            ./deploy/scripts/deploy.sh

            # ë³´ì•ˆ: í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ì œê±°
            rm -f .env.deploy

            echo "âœ… ${{ steps.vars.outputs.environment }} deployment completed successfully!"

      - name: Verify deployment status
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "âœ… ${{ steps.vars.outputs.environment }} deployment verification completed"
            echo "ðŸ“Š Final container status:"
            cd /home/${{ secrets.SERVER_USERNAME }}/${{ steps.vars.outputs.deploy_path }}/deploy
            docker-compose ps

  notify:
    name: Notify Deployment Result
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Notify Slack
        if: vars.SLACK_WEBHOOK_URL != ''
        run: |
          STATUS="${{ needs.deploy.result }}"
          if [ "$STATUS" = "success" ]; then
            STATUS_KR="ì„±ê³µ"
            EMOJI="ðŸŽ‰"
            COLOR="good"
          else
            STATUS_KR="ì‹¤íŒ¨"
            EMOJI="ðŸ’¥"
            COLOR="danger"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"${COLOR}\",
                \"title\": \"${EMOJI} ë°°í¬ ${STATUS_KR}\",
                                 \"fields\": [
                   {\"title\": \"í”„ë¡œì íŠ¸\", \"value\": \"KAMF\", \"short\": true},
                   {\"title\": \"í™˜ê²½\", \"value\": \"${{ needs.deploy.outputs.environment }}\", \"short\": true},
                   {\"title\": \"ë„ë©”ì¸\", \"value\": \"${{ needs.deploy.outputs.domain }}\", \"short\": true},
                   {\"title\": \"ë¸Œëžœì¹˜\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                   {\"title\": \"ë°°í¬ìž\", \"value\": \"${{ github.actor }}\", \"short\": true},
                   {\"title\": \"ì´ë¯¸ì§€ íƒœê·¸\", \"value\": \"${{ needs.deploy.outputs.image_tag }}\", \"short\": true},
                   {\"title\": \"ì»¤ë°‹\", \"value\": \"${{ github.sha }}\", \"short\": false},
                   {\"title\": \"ì‹œê°„\", \"value\": \"$(date '+%Y-%m-%d %H:%M:%S')\", \"short\": false}
                 ]
              }]
            }" \
            "${{ vars.SLACK_WEBHOOK_URL }}"

      - name: Create deployment record
        if: needs.deploy.result == 'success'
        run: |
          echo "ðŸ“ Deployment record created:"
          echo "  - Status: ${{ needs.deploy.result }}"
          echo "  - Image Tag: ${{ github.sha }}"
          echo "  - Deployed by: ${{ github.actor }}"
          echo "  - Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
